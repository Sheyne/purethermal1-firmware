
#include <stdint.h>
#include "stm32f4xx_hal.h"
#include "usb_device.h"


#include "pt.h"
#include "lepton.h"
#include "lepton_i2c.h"
#include "tmp007_i2c.h"
#include "usbd_uvc.h"
#include "usbd_uvc_if.h"


#include "tasks.h"

#include "project_config.h"

extern volatile uint8_t uvc_stream_status;
extern struct uvc_streaming_control videoCommitControl;


static int last_frame_count;
static y8_full_buffer *last_buffer;

#ifdef USART_DEBUG
#define DEBUG_PRINTF(...) printf( __VA_ARGS__);
#else
#define DEBUG_PRINTF(...)
#endif

void HAL_RCC_CSSCallback(void) {
    DEBUG_PRINTF("Oh no! HAL_RCC_CSSCallback()\r\n");
}

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
    DEBUG_PRINTF("Yay! HAL_GPIO_EXTI_Callback()\r\n");
}


static inline uint8_t clamp (float x)
{
  if (x < 0)         return 0;
  else if (x > 255)  return 255;
  else               return (uint8_t)x;
}

uint8_t colormap_ironblack[256][3] = {{235, 128, 128}, {233, 128, 128}, {231, 128, 128}, {229, 128, 128}, {228, 128, 128}, {226, 128, 128}, {224, 128, 128}, {223, 128, 128}, {221, 128, 128}, {219, 128, 128}, {217, 128, 128}, {216, 128, 128}, {214, 128, 128}, {212, 128, 128}, {210, 128, 128}, {209, 128, 128}, {207, 128, 128}, {205, 128, 128}, {204, 128, 128}, {202, 128, 128}, {200, 128, 128}, {198, 128, 128}, {197, 128, 128}, {195, 128, 128}, {193, 128, 128}, {192, 128, 128}, {190, 128, 128}, {188, 128, 128}, {186, 128, 128}, {185, 128, 128}, {183, 128, 128}, {181, 128, 128}, {180, 128, 128}, {178, 128, 128}, {176, 128, 128}, {174, 128, 128}, {173, 128, 128}, {171, 128, 128}, {169, 128, 128}, {168, 128, 128}, {166, 128, 128}, {164, 128, 128}, {162, 128, 128}, {161, 128, 128}, {159, 128, 128}, {157, 128, 128}, {156, 128, 128}, {154, 128, 128}, {152, 128, 128}, {150, 128, 128}, {149, 128, 128}, {147, 128, 128}, {145, 128, 128}, {143, 128, 128}, {142, 128, 128}, {140, 128, 128}, {138, 128, 128}, {137, 128, 128}, {135, 128, 128}, {133, 128, 128}, {131, 128, 128}, {130, 128, 128}, {128, 128, 128}, {126, 128, 128}, {124, 128, 128}, {122, 128, 128}, {120, 128, 128}, {119, 128, 128}, {117, 128, 128}, {115, 128, 128}, {113, 128, 128}, {112, 128, 128}, {110, 128, 128}, {108, 128, 128}, {107, 128, 128}, {105, 128, 128}, {103, 128, 128}, {101, 128, 128}, {100, 128, 128}, {98, 128, 128}, {96, 128, 128}, {95, 128, 128}, {93, 128, 128}, {91, 128, 128}, {89, 128, 128}, {88, 128, 128}, {86, 128, 128}, {84, 128, 128}, {83, 128, 128}, {81, 128, 128}, {79, 128, 128}, {77, 128, 128}, {76, 128, 128}, {74, 128, 128}, {72, 128, 128}, {70, 128, 128}, {69, 128, 128}, {67, 128, 128}, {65, 128, 128}, {64, 128, 128}, {62, 128, 128}, {60, 128, 128}, {58, 128, 128}, {57, 128, 128}, {55, 128, 128}, {53, 128, 128}, {52, 128, 128}, {50, 128, 128}, {48, 128, 128}, {46, 128, 128}, {45, 128, 128}, {43, 128, 128}, {41, 128, 128}, {40, 128, 128}, {38, 128, 128}, {36, 128, 128}, {34, 128, 128}, {33, 128, 128}, {31, 128, 128}, {29, 128, 128}, {28, 128, 128}, {26, 128, 128}, {24, 128, 128}, {22, 128, 128}, {21, 128, 128}, {19, 128, 128}, {17, 128, 128}, {16, 128, 128}, {16, 131, 127}, {18, 134, 127}, {19, 137, 128}, {20, 140, 128}, {21, 143, 128}, {22, 146, 129}, {24, 149, 129}, {25, 152, 129}, {26, 154, 130}, {28, 157, 131}, {29, 160, 131}, {30, 163, 131}, {31, 166, 132}, {33, 169, 132}, {34, 172, 132}, {35, 175, 133}, {36, 175, 135}, {38, 175, 137}, {39, 174, 139}, {41, 174, 141}, {42, 174, 143}, {43, 173, 145}, {45, 173, 148}, {46, 173, 150}, {48, 172, 151}, {49, 172, 154}, {51, 172, 156}, {52, 171, 158}, {54, 171, 160}, {55, 171, 162}, {56, 170, 164}, {58, 170, 166}, {59, 170, 168}, {60, 169, 171}, {62, 169, 172}, {63, 168, 174}, {65, 167, 176}, {66, 167, 178}, {68, 166, 180}, {69, 165, 182}, {70, 165, 183}, {72, 164, 185}, {73, 163, 187}, {75, 163, 189}, {76, 162, 191}, {78, 161, 193}, {79, 161, 194}, {81, 160, 197}, {83, 157, 197}, {84, 153, 197}, {86, 150, 198}, {87, 146, 198}, {89, 143, 198}, {90, 139, 198}, {92, 136, 199}, {94, 132, 199}, {95, 129, 199}, {97, 125, 199}, {98, 122, 200}, {100, 118, 200}, {102, 115, 200}, {103, 111, 200}, {105, 108, 201}, {106, 104, 201}, {107, 99, 201}, {108, 97, 201}, {110, 95, 200}, {112, 93, 200}, {114, 90, 199}, {115, 88, 198}, {117, 86, 197}, {119, 84, 197}, {121, 81, 196}, {122, 79, 195}, {124, 77, 194}, {126, 75, 194}, {128, 72, 193}, {129, 70, 192}, {131, 68, 192}, {133, 66, 191}, {135, 65, 190}, {137, 63, 189}, {138, 63, 188}, {141, 61, 187}, {143, 60, 186}, {144, 59, 185}, {146, 58, 184}, {149, 57, 183}, {150, 56, 181}, {153, 55, 180}, {155, 54, 179}, {156, 53, 178}, {158, 51, 177}, {161, 50, 176}, {162, 49, 175}, {164, 48, 174}, {166, 47, 172}, {169, 46, 171}, {170, 45, 170}, {173, 45, 169}, {174, 45, 168}, {177, 44, 166}, {178, 43, 165}, {181, 42, 164}, {182, 42, 163}, {185, 41, 162}, {186, 41, 161}, {189, 40, 160}, {191, 40, 158}, {193, 39, 157}, {195, 39, 156}, {197, 38, 155}, {199, 41, 153}, {202, 46, 152}, {204, 52, 150}, {206, 57, 148}, {208, 63, 147}, {211, 69, 145}, {213, 74, 143}, {215, 80, 141}, {218, 86, 140}, {220, 91, 138}, {223, 97, 136}, {225, 102, 135}, {227, 108, 133}, {229, 114, 131}, {232, 119, 130}, {212, 26, 144}};


PT_THREAD( usb_task(struct pt *pt))
{
    static uint16_t count = 0;
    static uint8_t uvc_header[2] = { 2, 0 };
    static uint32_t uvc_xmit_row = 0;
    static uint8_t packet[VIDEO_PACKET_SIZE];
    static uint8_t frame_number = 0;

    PT_BEGIN(pt);

    while (1)
    {
        PT_WAIT_UNTIL(pt, get_lepton_buffer(NULL) != last_frame_count);
        last_frame_count = get_lepton_buffer(&last_buffer);

    // perform stream initialization
    if (uvc_stream_status == 1)
    {
      DEBUG_PRINTF("Starting UVC stream...\r\n");

      uvc_header[0] = 2;
      uvc_header[1] = 0;
      UVC_Transmit_FS(uvc_header, 2);

      uvc_stream_status = 2;
      uvc_xmit_row = 0;
    }

    // put image on stream as long as stream is open
    while (uvc_stream_status == 2) {
        count = 0;

        packet[count++] = uvc_header[0];
        packet[count++] = uvc_header[1];

        switch (videoCommitControl.bFormatIndex) {
        case VS_FMT_INDEX(YUYV): {
            while (uvc_xmit_row < SHEYNE_HEIGHT && count + SHEYNE_WIDTH * 2 <= VIDEO_PACKET_SIZE) {
            	int segment_index = uvc_xmit_row / (SHEYNE_HEIGHT / 4);
            	int segment_row = uvc_xmit_row - segment_index * (SHEYNE_HEIGHT / 4);

            	for(int i = 0; i < SHEYNE_WIDTH; i++){
                	uint8_t grey = last_buffer->segments[segment_index][segment_row][i];
                	packet[count++] = colormap_ironblack[grey][1 + i % 2];
                	packet[count++] = colormap_ironblack[grey][0];
            	}

            	uvc_xmit_row++;
            }
            // image is done
            if (uvc_xmit_row == SHEYNE_HEIGHT) {
                packet[1] |= 0x2; // Flag end of frame
            }

            break;
        }
    }

      int retries = 1000;
      while (UVC_Transmit_FS(packet, count) == USBD_BUSY && uvc_stream_status == 2)
      {
        if (--retries == 0) {
          break;
        }
      }

      if (packet[1] & 0x2)
      {
        uvc_header[1] ^= 1; // toggle bit 0 for next new frame
        uvc_xmit_row = 0;
        frame_number ++;
        break;
      }
      PT_YIELD(pt);
    }
    PT_YIELD(pt);
    }
    PT_END(pt);
}
